{"version":3,"sources":["ChessBuff.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"../../../../../../assets/Script/AutoBattle/Model","sourcesContent":["import { ChessNpc } from \"./ChessNpc\";\nimport { EffData } from \"./EffectInfo\";\nimport { BuffAndDotState, DebuffState } from \"../SkillEffect/SkillEffectEnum\";\nimport { skillEffects } from \"../SkillEffect/InitSkillEffect\";\nimport { printBattleMsg, pTag, pBattleAction, printDefault } from \"../OutPut/Printer\";\n/**\n * \n */\nexport class ChessBuff {\n    private _lifeTime = 0;\n    private _deltaTime = 0;\n    protected _chessNpc: ChessNpc;\n    private _effData: EffData;\n    private _stateId: BuffAndDotState;\n    private _dt = 0;\n    private _isTriggerOnce = false;   // 是否只触发一次效果\n    private _isForever = false; //永久被动\n\n    private attrChange: { [index: string]: AttrChangeInfo };\n\n    /**\n     * \n     * @param lifeTime 持续时间，0的时候表示永久有效\n     * @param deltaTime 生效间隔，0的时候表示只生效一次\n     * @param chessNpc 添加目标\n     * @param effData \n     * @param stateId \n     */\n    constructor(lifeTime: number, deltaTime: number, chessNpc: ChessNpc, effData?: EffData, stateId?: BuffAndDotState) {\n        this._lifeTime = lifeTime;\n        this._deltaTime = deltaTime;\n        if (this._deltaTime == 0) {\n            this._isTriggerOnce = true;\n        }\n        if (lifeTime == 0) {\n            this._isForever = true;\n        }\n        this._chessNpc = chessNpc;\n        this._effData = effData;\n        if (stateId) {\n            this._stateId = stateId;\n            chessNpc.addBuffState(stateId);\n            /**\n             * 韧性降低负面效果\n             */\n            if (DebuffState[stateId]) {\n                let rd = chessNpc.getAttrChange(\"reduceDebuffTime\")\n                if (rd && rd.length > 0) {\n                    for (let i = 0; i < rd.length; i++) {\n                        const per = rd[i].info;\n                        lifeTime = lifeTime * (100 - per) / 100;\n                    }\n                }\n                this._lifeTime = lifeTime;\n            }\n            printBattleMsg(pTag.battle, pBattleAction.addDebuff, { time: this._lifeTime });\n        }\n        this.update(0);\n    }\n\n    update(dt: number) {\n        if (this._lifeTime > 0 && !this._isForever) {\n            this._lifeTime = this._lifeTime - dt;\n            if (this._lifeTime <= 0) {\n                this.destroy()\n            }\n        }\n        if (!this._isTriggerOnce) {\n            this._dt = this._dt - dt;\n            if (this._dt <= 0) {\n                this.doBuffEffect()\n                this._dt = this._deltaTime + this._dt;\n            }\n        }\n    }\n\n    doBuffEffect() {\n        if (this._effData) {\n            let effId = this._effData.skillEff.effId;\n            skillEffects[effId].play(this._effData);\n        }\n    }\n\n    /**\n     * buff销毁时的操作\n     */\n    destroy() {\n        if (this._stateId) {\n            this._chessNpc.removeBuffState(this._stateId);\n        }\n        if (this.attrChange && this._chessNpc) {\n            for (const key in this.attrChange) {\n                if (this.attrChange.hasOwnProperty(key)) {\n                    const attrChange = this.attrChange[key];\n                    this._chessNpc.removeAttrChange(key, attrChange.idx);\n                }\n            }\n        }\n    }\n\n    setAttrChange(attrName: string, value: any) {\n        if (this._chessNpc) {\n            let attrChangeInfo = new AttrChangeInfo(value);\n            this._chessNpc.addAttrChange(attrName, attrChangeInfo);\n            if (!this.attrChange) {\n                this.attrChange = {};\n            }\n            this.attrChange[attrName] = attrChangeInfo;\n        }\n    }\n\n    getAttrChange(attrName: string) {\n        if (this.attrChange) {\n            return this.attrChange[attrName];\n        }\n        return null;\n    }\n\n    get isValid() {\n        return this._lifeTime > 0 || this._isForever;\n    }\n\n    checkIsValid() {\n        return this._lifeTime > 0 || this._isForever;\n    }\n}\n\nexport class AttrChangeInfo {\n    idx: number;\n    info: any;\n    constructor(info: any) {\n        this.idx = 0;\n        this.info = info;\n    }\n}\n\n/**\n * 护盾的实现机制不是很理想，欢迎重构这部分代码或提供意见\n */\nexport class ChessShield extends ChessBuff {\n    private _lifeCount = 0;\n    protected shieldData: any;\n    idx = 0;\n    name = \"ChessShield\";\n\n    constructor(lifeTime: number, lifeCount: number, chessNpc: ChessNpc, shieldData: any) {\n        super(lifeTime, 0, chessNpc);\n        this._lifeCount = lifeCount;\n        this.shieldData = shieldData;\n    }\n\n    /**\n     * 执行护盾过程\n     * @param arg 一个对象，既是传入值，也传出结果\n     * @returns 返回值返回该次处理是否成功，如果护盾已失效，则返回false\n     */\n    doShieldEffect(arg: object) {\n        this._lifeCount = this._lifeCount - 1;\n        return this._lifeCount >= 0;\n    }\n\n    update(dt: number) {\n        super.update(dt);\n        if (this._lifeCount <= 0) {\n            this.destroy();\n        }\n    }\n\n    destroy() {\n        super.destroy();\n        this._chessNpc.removeShield(this);\n    }\n\n    get isValid() {\n        return super.checkIsValid() && this._lifeCount > 0;\n    }\n}\n\nexport class AddDamageShield extends ChessShield {\n    name = \"AddDamageShield\";\n    doShieldEffect(arg: { damage: number }) {\n        if (!super.doShieldEffect(null)) {\n            return false;\n        }\n        arg.damage = arg.damage + this.shieldData;\n        return true;\n    }\n}\n\nexport class MissDamageShield extends ChessShield {\n    name = \"MissDamageShield\";\n    doShieldEffect(arg: { damage: number }) {\n        if (!super.doShieldEffect(null)) {\n            return false;\n        }\n        arg.damage = 0;\n        printBattleMsg(pTag.battle, pBattleAction.missDamage);\n        return true;\n    }\n}\n"]}